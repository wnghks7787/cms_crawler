services:
  db:
    image: mariadb:10.5
    container_name: mw-legacy-${MW_VER}-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: mw
      MYSQL_USER: mw
      MYSQL_PASSWORD: mwpass
      MYSQL_ROOT_PASSWORD: rootpass
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-pmwpass"]
      interval: 5s
      timeout: 3s
      retries: 30
    command: ["--sql-mode="]
    volumes:
      - mw-db:/var/lib/mysql
    networks:
      - mw-net

  wiki:
    build:
      context: .
      args:
        PHP_BASE: ${PHP_BASE}
        MW_VER: ${MW_VER}
    container_name: mw-legacy-${MW_VER}
    depends_on:
      - db
    restart: unless-stopped
    ports:
      - "${HOST_PORT}:80"
    environment:
      MW_DB_HOST: db
      MW_DB_NAME: mw
      MW_DB_USER: mw
      MW_DB_PASS: mwpass
      MW_SITE_NAME: "MW ${MW_VER}"
      MW_ADMIN_USER: admin
    volumes:
      - mw-images:/var/www/html/images
    networks:
      - mw-net

volumes:
  mw-db:
  mw-images:

networks:
  mw-net:
    external: true     # ← 최상위에서 외부 네트워크로 지정
    name: mw-shared    # ← 실제 도커 네트워크 이름

